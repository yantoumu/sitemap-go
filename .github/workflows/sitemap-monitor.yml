name: Sitemap Monitor

on:
  # å®šæ—¶è¿è¡Œï¼šæ¯å¤©2æ¬¡
  # ä¸­å›½æ—¶é—´(UTC+8): æ—©ä¸Š7:00 = UTC 23:00(å‰ä¸€å¤©)
  # ä¸­å›½æ—¶é—´(UTC+8): æ™šä¸Š23:00 = UTC 15:00
  schedule:
    - cron: '0 23 * * *'  # ä¸­å›½æ—¶é—´æ—©ä¸Š7:00
    - cron: '0 15 * * *'  # ä¸­å›½æ—¶é—´æ™šä¸Š23:00
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sitemap_workers:
        description: 'Number of sitemap workers'
        required: false
        default: '15'
      api_workers:
        description: 'Number of API workers'
        required: false
        default: '2'
      debug:
        description: 'Enable debug logging'
        required: false
        default: 'false'

env:
  GO_VERSION: '1.21'

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          /go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Download dependencies
      run: go mod download
      
    - name: Build sitemap monitor
      run: |
        go mod tidy
        go build -ldflags="-s -w" -o sitemap-go main.go
        chmod +x sitemap-go
        echo "âœ… Build completed successfully"
        echo "ğŸ“¦ Binary size: $(ls -lh sitemap-go | awk '{print $5}')"
    
    - name: Create data directory
      run: mkdir -p ./data
    
    - name: Run sitemap monitoring
      env:
        # å¿…éœ€çš„é…ç½® (ä» GitHub Secrets)
        BACKEND_URL: ${{ secrets.BACKEND_API_URL }}
        BACKEND_API_KEY: ${{ secrets.BACKEND_API_KEY }}
        TRENDS_API_URL: ${{ secrets.TRENDS_API_URL }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        
        # åŸºç¡€é…ç½® (å¯è°ƒæ•´)
        SITEMAP_WORKERS: ${{ github.event.inputs.sitemap_workers || '15' }}
        API_WORKERS: ${{ github.event.inputs.api_workers || '4' }}
        DEBUG: ${{ github.event.inputs.debug || 'false' }}
        
        # æ€§èƒ½é…ç½® (GitHub Actions ä¼˜åŒ–)
        API_RATE_LIMIT: '1.0'      # è°¨æ…çš„APIè¯·æ±‚é¢‘ç‡
        SITEMAP_RATE_LIMIT: '20.0' # é€‚ä¸­çš„sitemapæŠ“å–é¢‘ç‡ (GitHub Actionsç½‘ç»œ)
        BATCH_SIZE: '300'          # æ‰¹é‡æäº¤å¤§å°
        MAX_URLS_PER_SITEMAP: '50000'  # é™åˆ¶å¤§å‹sitemap
        
        # é»˜è®¤ç›‘æ§ç½‘ç«™ (ä» secrets è®¾ç½®)
        SITEMAP_URLS: ${{ secrets.SITEMAP_URLS }}
      run: |
        echo "ğŸš€ Starting sitemap monitoring with optimized configuration..."
        echo "ğŸ“Š Configuration:"
        echo "  - Sitemap workers: $SITEMAP_WORKERS"
        echo "  - API workers: $API_WORKERS"
        echo "  - Debug mode: $DEBUG"
        echo "  - API rate limit: $API_RATE_LIMIT req/sec"
        echo "  - Sitemap rate limit: $SITEMAP_RATE_LIMIT req/sec"
        
        # æ£€æŸ¥ SITEMAP_URLS è®¾ç½®
        if [ -z "$SITEMAP_URLS" ]; then
          echo "ğŸ“ Note: SITEMAP_URLS not set, will use default sitemap list"
        else
          echo "ğŸ“ SITEMAP_URLS is configured (URLs are masked for security)"
        fi
        
        # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
        if [ -z "$BACKEND_URL" ]; then
          echo "âŒ ERROR: BACKEND_API_URL secret is required"
          echo "Please set BACKEND_API_URL in GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "$BACKEND_API_KEY" ]; then
          echo "âŒ ERROR: BACKEND_API_KEY secret is required"
          echo "Please set BACKEND_API_KEY in GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "$TRENDS_API_URL" ]; then
          echo "âŒ ERROR: TRENDS_API_URL secret is required"
          echo "Please set TRENDS_API_URL in GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "$ENCRYPTION_KEY" ]; then
          echo "âŒ ERROR: ENCRYPTION_KEY secret is required"
          echo "Please set ENCRYPTION_KEY in GitHub repository secrets"
          echo "Generate with: openssl rand -base64 32"
          exit 1
        fi
        
        # è¿è¡Œç›‘æ§è„šæœ¬
        ./sitemap-go
        
    - name: Upload monitoring results (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-logs-${{ github.run_number }}
        path: |
          ./data/
          *.log
        retention-days: 7
        compression-level: 6
        include-hidden-files: false
    
    - name: Create summary report
      if: always()
      run: |
        echo "## ğŸ” Sitemap Monitoring Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **UTC Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **China Time**: $(TZ='Asia/Shanghai' date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**:" >> $GITHUB_STEP_SUMMARY
        echo "  - Sitemap Workers: $SITEMAP_WORKERS" >> $GITHUB_STEP_SUMMARY
        echo "  - API Workers: $API_WORKERS" >> $GITHUB_STEP_SUMMARY
        echo "  - Debug Mode: $DEBUG" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "./data/processed_urls.json" ]; then
          PROCESSED_COUNT=$(wc -l < "./data/processed_urls.json" 2>/dev/null || echo "0")
          echo "- **Processed URLs**: $PROCESSED_COUNT" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "./data/failed_keywords.json" ]; then
          FAILED_COUNT=$(wc -l < "./data/failed_keywords.json" 2>/dev/null || echo "0")
          echo "- **Failed Keywords**: $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY
        fi

  # å¯é€‰ï¼šé€šçŸ¥ä½œä¸š (å¦‚æœéœ€è¦)
  notify:
    runs-on: ubuntu-latest
    needs: monitor
    if: failure()  # ä»…åœ¨ç›‘æ§å¤±è´¥æ—¶é€šçŸ¥
    
    steps:
    - name: Notify on failure
      run: |
        echo "âŒ Sitemap monitoring failed at $(date -u)"
        echo "ğŸ”— Job URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  Slackã€Discord æˆ–å…¶ä»–é€šçŸ¥
        # ä¾‹å¦‚ï¼šcurl -X POST "webhook-url" -d "Sitemap monitoring failed"
