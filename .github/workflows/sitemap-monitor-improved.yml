name: Sitemap Monitor (Improved)

on:
  # å®šæ—¶è¿è¡Œï¼šæ¯å¤©2æ¬¡
  # ä¸­å›½æ—¶é—´(UTC+8): æ—©ä¸Š7:00 = UTC 23:00(å‰ä¸€å¤©)
  # ä¸­å›½æ—¶é—´(UTC+8): æ™šä¸Š23:00 = UTC 15:00
  schedule:
    - cron: '0 23 * * *'  # ä¸­å›½æ—¶é—´æ—©ä¸Š7:00
    - cron: '0 15 * * *'  # ä¸­å›½æ—¶é—´æ™šä¸Š23:00
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sitemap_workers:
        description: 'Number of sitemap workers'
        required: false
        default: '30'
      api_workers:
        description: 'Number of API workers'
        required: false
        default: '8'
      debug:
        description: 'Enable debug logging'
        required: false
        default: 'false'

env:
  GO_VERSION: '1.21'

jobs:
  monitor:
    runs-on: ubuntu-latest

    # æ·»åŠ å¿…è¦çš„æƒé™ä»¥æ”¯æŒå‘mainåˆ†æ”¯æ¨é€
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´çš„gitå†å²ä»¥æ”¯æŒæ•°æ®æäº¤
        fetch-depth: 0
        # ç¡®ä¿å¯ä»¥æ¨é€åˆ°mainåˆ†æ”¯
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          /go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    # ç¼“å­˜ç›‘æ§æ•°æ®ä»¥å®ç°æŒä¹…åŒ–
    - name: Cache monitoring data
      uses: actions/cache@v4
      with:
        path: ./data
        key: monitoring-data-${{ runner.os }}-${{ github.run_number }}
        restore-keys: |
          monitoring-data-${{ runner.os }}-
          
    - name: Download dependencies
      run: go mod download
      
    - name: Build sitemap monitor
      run: |
        go mod tidy
        go build -ldflags="-s -w" -o sitemap-go main.go
        chmod +x sitemap-go
        echo "âœ… Build completed successfully"
        echo "ğŸ“¦ Binary size: $(ls -lh sitemap-go | awk '{print $5}')"
    
    - name: Create data directory and restore previous data
      env:
        DATA_BRANCH: 'monitoring-data'
      run: |
        # åˆ›å»ºæ­£ç¡®çš„æ•°æ®ç›®å½•ç»“æ„ï¼ˆåŒ¹é…EncryptedFileStorageçš„getFilePathé€»è¾‘ï¼‰
        mkdir -p ./data/pr ./data/fa ./data/si ./data-export
        
        # ä»æ•°æ®åˆ†æ”¯æ¢å¤ä¹‹å‰çš„ç›‘æ§æ•°æ®
        if git ls-remote --heads origin ${DATA_BRANCH} | grep -q ${DATA_BRANCH}; then
          echo "ğŸ“¥ Restoring previous monitoring data from ${DATA_BRANCH} branch..."
          git fetch origin ${DATA_BRANCH}
          
          # ç›´æ¥æ£€å‡ºdataç›®å½•ï¼Œä¿æŒå®Œæ•´çš„ç›®å½•ç»“æ„
          git checkout origin/${DATA_BRANCH} -- data/ 2>/dev/null || echo "No previous data directory found"
          
          # éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦æ­£ç¡®æ¢å¤
          if [ -f "./data/pr/processed_urls.enc" ]; then
            echo "âœ… Restored processed URLs: $(stat -c%s "./data/pr/processed_urls.enc" 2>/dev/null || echo "unknown") bytes"
          else
            echo "ğŸ“ No processed URLs found"
          fi
          
          if [ -f "./data/fa/failed_keywords.enc" ]; then
            echo "âœ… Restored failed keywords: $(stat -c%s "./data/fa/failed_keywords.enc" 2>/dev/null || echo "unknown") bytes"
          else
            echo "ğŸ“ No failed keywords found"
          fi
          
          # ç»Ÿè®¡sitemapæ•°æ®æ–‡ä»¶
          SITEMAP_FILES=$(find ./data/si -name "*.enc" 2>/dev/null | wc -l)
          echo "âœ… Restored $SITEMAP_FILES sitemap data files"
          
          echo "ğŸ“Š Total restored files: $(find ./data -name "*.enc" 2>/dev/null | wc -l)"
          
          # éªŒè¯åŠ å¯†å¯†é’¥ä¸€è‡´æ€§ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
          if git checkout origin/${DATA_BRANCH} -- DATA_SUMMARY.txt 2>/dev/null; then
            STORED_HASH=$(grep "Key Hash:" DATA_SUMMARY.txt | cut -d' ' -f3 2>/dev/null || echo "")
            CURRENT_HASH=$(echo -n "$ENCRYPTION_KEY" | sha256sum | cut -d' ' -f1 | head -c 8)
            if [ "$STORED_HASH" != "" ] && [ "$STORED_HASH" != "$CURRENT_HASH" ]; then
              echo "âš ï¸ WARNING: Encryption key mismatch detected!"
              echo "  Previous hash: $STORED_HASH"
              echo "  Current hash:  $CURRENT_HASH"
              echo "  This may prevent data loading. Consider key rotation if needed."
            else
              echo "âœ… Encryption key consistency verified"
            fi
            rm -f DATA_SUMMARY.txt # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          fi
        else
          echo "ğŸ“ No previous data branch found, starting fresh"
        fi
    
    - name: Run sitemap monitoring
      env:
        # å¿…éœ€çš„é…ç½® (ä» GitHub Secrets)
        BACKEND_URL: ${{ secrets.BACKEND_API_URL }}
        BACKEND_API_KEY: ${{ secrets.BACKEND_API_KEY }}
        TRENDS_API_URL: ${{ secrets.TRENDS_API_URL }}
        TRENDS_API_URL_SECONDARY: ${{ secrets.TRENDS_API_URL_SECONDARY || secrets.TRENDS_API_URL }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        
        # åŸºç¡€é…ç½® (å¯è°ƒæ•´)
        SITEMAP_WORKERS: ${{ github.event.inputs.sitemap_workers || '30' }}
        API_WORKERS: ${{ github.event.inputs.api_workers || '8' }}
        DEBUG: ${{ github.event.inputs.debug || 'false' }}
        
        # æ€§èƒ½é…ç½® (GitHub Actions ä¼˜åŒ–)
        API_RATE_LIMIT: '5.0'       # ä¼˜åŒ–APIè¯·æ±‚é¢‘ç‡ï¼ˆé¿å…429é”™è¯¯ï¼‰
        SITEMAP_RATE_LIMIT: '30.0'  # é€‚ä¸­çš„sitemapæŠ“å–é¢‘ç‡
        BATCH_SIZE: '5'             # 5ä¸ªå…³é”®è¯æ‰¹é‡æŸ¥è¯¢ï¼ˆç¬¦åˆAPIé™åˆ¶ï¼‰
        MAX_URLS_PER_SITEMAP: '50000'  # é™åˆ¶å¤§å‹sitemap
        
        # é»˜è®¤ç›‘æ§ç½‘ç«™ (ä» secrets è®¾ç½®)
        SITEMAP_URLS: ${{ secrets.SITEMAP_URLS }}
        
        # GitHub Actions ç¯å¢ƒæ ‡è®°
        GITHUB_ACTIONS: 'true'
      run: |
        echo "ğŸš€ Starting sitemap monitoring with optimized configuration..."
        echo "ğŸ“Š Configuration:"
        echo "  - Sitemap workers: $SITEMAP_WORKERS"
        echo "  - API workers: $API_WORKERS"
        echo "  - Debug mode: $DEBUG"
        echo "  - API rate limit: $API_RATE_LIMIT req/sec"
        echo "  - Sitemap rate limit: $SITEMAP_RATE_LIMIT req/sec"
        echo "  - Batch size: $BATCH_SIZE keywords"
        
        # æ£€æŸ¥ SITEMAP_URLS è®¾ç½®
        if [ -z "$SITEMAP_URLS" ]; then
          echo "ğŸ“ Note: SITEMAP_URLS not set, will use default sitemap list"
        else
          echo "ğŸ“ SITEMAP_URLS is configured (URLs are masked for security)"
        fi
        
        # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
        if [ -z "$BACKEND_URL" ]; then
          echo "âŒ ERROR: BACKEND_API_URL secret is required"
          echo "Please set BACKEND_API_URL in GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "$BACKEND_API_KEY" ]; then
          echo "âŒ ERROR: BACKEND_API_KEY secret is required"
          echo "Please set BACKEND_API_KEY in GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "$TRENDS_API_URL" ]; then
          echo "âŒ ERROR: TRENDS_API_URL secret is required"
          echo "Please set TRENDS_API_URL in GitHub repository secrets"
          exit 1
        fi
        
        if [ -z "$ENCRYPTION_KEY" ]; then
          echo "âŒ ERROR: ENCRYPTION_KEY secret is required"
          echo "Please set ENCRYPTION_KEY in GitHub repository secrets"
          echo "Generate with: openssl rand -base64 32"
          exit 1
        fi
        
        # è¿è¡Œç›‘æ§è„šæœ¬
        ./sitemap-go
        
    # æ€»æ˜¯ä¸Šä¼ ç›‘æ§ç»“æœï¼ˆæˆåŠŸå’Œå¤±è´¥éƒ½ä¸Šä¼ ï¼‰
    - name: Upload monitoring results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-results-${{ github.run_number }}
        path: |
          ./data/
          ./data-export/
          *.log
        retention-days: 30
        compression-level: 6
        include-hidden-files: false
    
    - name: Create summary report
      if: always()
      run: |
        echo "## ğŸ” Sitemap Monitoring Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **UTC Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **China Time**: $(TZ='Asia/Shanghai' date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**:" >> $GITHUB_STEP_SUMMARY
        echo "  - Sitemap Workers: $SITEMAP_WORKERS" >> $GITHUB_STEP_SUMMARY
        echo "  - API Workers: $API_WORKERS" >> $GITHUB_STEP_SUMMARY
        echo "  - Debug Mode: $DEBUG" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å¯¼å‡ºçš„æ‘˜è¦æ–‡ä»¶
        if [ -f "./data-export/monitoring_summary.json" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Monitoring Statistics" >> $GITHUB_STEP_SUMMARY
          TOTAL_PROCESSED=$(jq -r .total_processed ./data-export/monitoring_summary.json)
          TOTAL_FAILED=$(jq -r .total_failed ./data-export/monitoring_summary.json)
          SUCCESS_RATE=$(jq -r .success_rate ./data-export/monitoring_summary.json)
          echo "- **Total Processed**: $TOTAL_PROCESSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Failed**: $TOTAL_FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Success Rate**: ${SUCCESS_RATE}%" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ˜¾ç¤ºæœ€è¿‘çš„å¤±è´¥å…³é”®è¯
        if [ -f "./data-export/failed_keywords_summary.json" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ Recent Failed Keywords" >> $GITHUB_STEP_SUMMARY
          jq -r '.recent_failures[:5][] | "- \(.keyword) from \(.sitemap_url)"' ./data-export/failed_keywords_summary.json >> $GITHUB_STEP_SUMMARY || true
        fi
        
    # å°†ç›‘æ§æ•°æ®æäº¤åˆ°ä¸“ç”¨æ•°æ®åˆ†æ”¯ï¼ˆå®‰å…¨çš„æŒä¹…åŒ–å­˜å‚¨ï¼‰
    - name: Commit monitoring data to data branch
      if: always() && github.event_name == 'schedule'
      env:
        DATA_BRANCH: 'monitoring-data'
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # æ£€æŸ¥æˆ–åˆ›å»ºæ•°æ®åˆ†æ”¯
        if git ls-remote --heads origin ${DATA_BRANCH} | grep -q ${DATA_BRANCH}; then
          echo "ğŸ“Š Switching to existing data branch..."
          git fetch origin ${DATA_BRANCH}:${DATA_BRANCH}
          git checkout ${DATA_BRANCH}
        else
          echo "ğŸ“Š Creating new data branch..."
          git checkout -b ${DATA_BRANCH}
          echo "# Monitoring Data Branch" > README.md
          echo "This branch contains automated monitoring data. DO NOT merge into main." >> README.md
          git add README.md
          git commit -m "chore: initialize data branch"
          git push origin ${DATA_BRANCH}
        fi

        # æ‹‰å–æœ€æ–°çš„æ•°æ®åˆ†æ”¯æ›´æ”¹
        git pull origin ${DATA_BRANCH} --rebase || echo "No remote changes"

        # æ¸…ç†è¶…è¿‡30å¤©çš„æ—§æ•°æ®ï¼ˆåœ¨æ•°æ®åˆ†æ”¯ä¸Šè¿›è¡Œï¼‰
        if [ -d "./data" ]; then
          find ./data -name "*.enc" -type f -mtime +30 -delete 2>/dev/null || true
          echo "ğŸ§¹ Cleaned old data files (>30 days)"
        fi

        # éªŒè¯å½“å‰æ•°æ®å®Œæ•´æ€§
        echo "ğŸ“Š Current data inventory:"
        PROCESSED_URLS=$([ -f "./data/pr/processed_urls.enc" ] && echo "âœ…" || echo "âŒ")
        FAILED_KEYWORDS=$([ -f "./data/fa/failed_keywords.enc" ] && echo "âœ…" || echo "âŒ")
        SITEMAP_COUNT=$(find ./data/si -name "*.enc" 2>/dev/null | wc -l)
        
        echo "  - Processed URLs: $PROCESSED_URLS"
        echo "  - Failed keywords: $FAILED_KEYWORDS"  
        echo "  - Sitemap files: $SITEMAP_COUNT"
        
        # ç”Ÿæˆç®€å•çš„æ•°æ®æ‘˜è¦ï¼ˆç¬¦åˆKISSåŸåˆ™ï¼‰
        echo "ğŸ“Š Monitoring Data Summary" > DATA_SUMMARY.txt
        echo "Run: ${{ github.run_number }}" >> DATA_SUMMARY.txt  
        echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> DATA_SUMMARY.txt
        echo "Processed URLs: $([ -f "./data/pr/processed_urls.enc" ] && echo "âœ…" || echo "âŒ")" >> DATA_SUMMARY.txt
        echo "Failed Keywords: $([ -f "./data/fa/failed_keywords.enc" ] && echo "âœ…" || echo "âŒ")" >> DATA_SUMMARY.txt
        echo "Sitemap Files: $SITEMAP_COUNT" >> DATA_SUMMARY.txt
        echo "Key Hash: $(echo -n "$ENCRYPTION_KEY" | sha256sum | cut -d' ' -f1 | head -c 8)" >> DATA_SUMMARY.txt

        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´ï¼ˆç°åœ¨ç›´æ¥æ£€æŸ¥dataç›®å½•ï¼‰
        if [ -n "$(git status --porcelain data/ DATA_SUMMARY.txt 2>/dev/null)" ]; then
          # æ·»åŠ ç›‘æ§æ•°æ®æ–‡ä»¶ï¼ˆç›´æ¥æ·»åŠ dataç›®å½•ï¼‰
          git add data/ DATA_SUMMARY.txt

          # æäº¤æ›´æ”¹ï¼ˆä½¿ç”¨[skip ci]é¿å…è§¦å‘å…¶ä»–å·¥ä½œæµï¼‰
          git commit -m "data: update monitoring - Run #${{ github.run_number }} [skip ci]
          
          - Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}"

          # æ¨é€åˆ°æ•°æ®åˆ†æ”¯
          git push origin ${DATA_BRANCH}
          echo "âœ… Successfully pushed monitoring data to ${DATA_BRANCH} branch"
          echo "ğŸ“Š View data at: https://github.com/${{ github.repository }}/tree/${DATA_BRANCH}"
        else
          echo "ğŸ“ No monitoring data changes detected, skipping commit"
        fi

        # åˆ‡å›mainåˆ†æ”¯ï¼ˆä¸ºäº†å·¥ä½œæµçš„åç»­æ­¥éª¤ï¼‰
        git checkout main || true

  # å¯é€‰ï¼šé€šçŸ¥ä½œä¸š (å¦‚æœéœ€è¦)
  notify:
    runs-on: ubuntu-latest
    needs: monitor
    if: failure()  # ä»…åœ¨ç›‘æ§å¤±è´¥æ—¶é€šçŸ¥
    
    steps:
    - name: Notify on failure
      run: |
        echo "âŒ Sitemap monitoring failed at $(date -u)"
        echo "ğŸ”— Job URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  Slackã€Discord æˆ–å…¶ä»–é€šçŸ¥
        # ä¾‹å¦‚ï¼šcurl -X POST "webhook-url" -d "Sitemap monitoring failed"